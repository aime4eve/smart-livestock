-- PostgreSQL初始化脚本

-- 创建牛只信息表
CREATE TABLE cattle (
  cattle_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  breed VARCHAR(50) NOT NULL,
  birth_date DATE NOT NULL,
  weight DECIMAL(5,2),
  gender VARCHAR(10) CHECK (gender IN ('公牛','母牛')) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建胶囊表
CREATE TABLE capsule (
  capsule_id VARCHAR(36) PRIMARY KEY,
  production_batch VARCHAR(20) NOT NULL,
  activation_date DATE NOT NULL,
  expiration_date DATE NOT NULL,
  status VARCHAR(50) CHECK (status IN ('库存','已安装','已回收')) DEFAULT '库存',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建安装记录表
CREATE TABLE capsule_installation (
  install_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  cattle_id INT NOT NULL REFERENCES cattle(cattle_id),
  capsule_id VARCHAR(36) NOT NULL REFERENCES capsule(capsule_id),
  install_time TIMESTAMP NOT NULL,
  operator VARCHAR(50)
);

-- 创建索引
CREATE INDEX idx_status ON capsule (status);
CREATE INDEX idx_install_time ON capsule_installation (install_time);

-- 插入牛只数据
INSERT INTO cattle (cattle_id, breed, birth_date, weight, gender, created_at) VALUES
(1, '安格斯', '2021-03-15', 623.45, '公牛', '2023-05-10T08:30:22'),
(2, '荷斯坦', '2020-07-22', 578.90, '母牛', '2023-05-12T14:15:36'),
(3, '海福特', '2022-01-05', 432.20, '公牛', '2023-05-14T10:45:18'),
(4, '夏洛莱', '2021-11-30', 545.75, '母牛', '2023-05-18T09:22:41'),
(5, '利木赞', '2020-09-18', 612.30, '公牛', '2023-06-01T11:05:37'),
(6, '西门塔尔', '2022-02-28', 389.65, '母牛', '2023-06-05T16:30:48'),
(7, '布拉曼', '2021-05-10', 567.80, '公牛', '2023-06-10T13:12:29'),
(8, '娟姗', '2020-12-03', 498.50, '母牛', '2023-06-15T10:40:15'),
(9, '南德文', '2021-08-25', 534.25, '公牛', '2023-06-20T08:55:33'),
(10, '短角', '2022-04-17', 410.70, '母牛', '2023-06-25T15:18:52');

-- 重置序列
SELECT setval(pg_get_serial_sequence('cattle', 'cattle_id'), 10);

-- 插入胶囊数据
INSERT INTO capsule (capsule_id, production_batch, activation_date, expiration_date, status, created_at) VALUES
('a1b2c3d4-e5f6-47g8-h9i0-j1k2l3m4n5o6', 'PB20241125-001', '2024-12-15', '2026-12-15', '已安装', '2025-01-12T10:30:22'),
('b2c3d4e5-f6g7-48h9-i0j1-k2l3m4n5o6p7', 'PB20241220-001', '2025-01-10', '2027-01-10', '已安装', '2025-02-07T09:45:18'),
('c3d4e5f6-g7h8-49i0-j1k2-l3m4n5o6p7q8', 'PB20241120-001', '2024-12-08', '2026-12-08', '已安装', '2025-01-05T14:22:36'),
('d4e5f6g7-h8i9-50j1-k2l3-m4n5o6p7q8r9', 'PB20250130-001', '2025-02-18', '2027-02-18', '已安装', '2025-03-18T11:15:43'),
('e5f6g7h8-i9j0-51k2-l3m4-n5o6p7q8r9s0', 'PB20250305-001', '2025-03-25', '2027-03-25', '库存', '2025-04-22T08:30:15'),
('f6g7h8i9-j0k1-52l3-m4n5-o6p7q8r9s0t1', 'PB20241215-002', '2025-01-05', '2027-01-05', '已安装', '2025-02-02T16:45:28'),
('g7h8i9j0-k1l2-53m4-n5o6-p7q8r9s0t1u2', 'PB20250325-001', '2025-04-12', '2027-04-12', '库存', '2025-05-10T13:20:55'),
('h8i9j0k1-l2m3-54n5-o6p7-q8r9s0t1u2v3', 'PB20241205-001', '2024-12-22', '2026-12-22', '已安装', '2025-01-19T09:10:33'),
('i9j0k1l2-m3n4-55o6-p7q8-r9s0t1u2v3w4', 'PB20250115-002', '2025-02-03', '2027-02-03', '已安装', '2025-03-03T15:35:47'),
('j0k1l2m3-n4o5-56p7-q8r9-s0t1u2v3w4x5', 'PB20250105-002', '2025-01-25', '2027-01-25', '已安装', '2025-02-22T12:25:18'),
('k1l2m3n4-o5p6-57q8-r9s0-t1u2v3w4x5y6', 'PB20250410-002', '2025-04-30', '2027-04-30', '库存', '2025-05-28T10:40:22'),
('l2m3n4o5-p6q7-58r9-s0t1-u2v3w4x5y6z7', 'PB20250220-002', '2025-03-08', '2027-03-08', '库存', '2025-04-05T14:15:36'),
('m3n4o5p6-q7r8-59s0-t1u2-v3w4x5y6z7a8', 'PB20241115-002', '2024-12-05', '2026-12-05', '已安装', '2025-01-02T11:50:42'),
('n4o5p6q7-r8s9-60t1-u2v3-w4x5y6z7a8b9', 'PB20250125-001', '2025-02-15', '2027-02-15', '已安装', '2025-03-15T09:30:15'),
('o5p6q7r8-s9t0-61u2-v3w4-x5y6z7a8b9c0', 'PB20250415-001', '2025-05-01', '2027-05-01', '库存', '2025-05-29T16:20:33');

-- 插入安装记录数据
INSERT INTO capsule_installation (install_id, cattle_id, capsule_id, install_time, operator) VALUES
(1, 1, 'a1b2c3d4-e5f6-47g8-h9i0-j1k2l3m4n5o6', '2024-12-18T09:15:30', 'hkt_admin'),
(2, 2, 'c3d4e5f6-g7h8-49i0-j1k2-l3m4n5o6p7q8', '2024-12-10T14:25:45', 'hkt_admin'),
(3, 3, 'h8i9j0k1-l2m3-54n5-o6p7-q8r9s0t1u2v3', '2024-12-23T11:05:20', 'hkt_admin'),
(4, 4, 'm3n4o5p6-q7r8-59s0-t1u2-v3w4x5y6z7a8', '2024-12-07T08:45:15', 'hkt_admin'),
(5, 5, 'f6g7h8i9-j0k1-52l3-m4n5-o6p7q8r9s0t1', '2025-01-08T13:30:55', 'hkt_admin'),
(6, 6, 'b2c3d4e5-f6g7-48h9-i0j1-k2l3m4n5o6p7', '2025-01-12T10:20:35', 'hkt_admin'),
(7, 7, 'j0k1l2m3-n4o5-56p7-q8r9-s0t1u2v3w4x5', '2025-01-28T15:40:25', 'hkt_admin'),
(8, 8, 'i9j0k1l2-m3n4-55o6-p7q8-r9s0t1u2v3w4', '2025-02-05T09:55:40', 'hkt_admin'),
(9, 9, 'd4e5f6g7-h8i9-50j1-k2l3-m4n5o6p7q8r9', '2025-02-20T14:10:05', 'hkt_admin'),
(10, 10, 'n4o5p6q7-r8s9-60t1-u2v3-w4x5y6z7a8b9', '2025-02-17T11:35:50', 'hkt_admin');

-- 重置序列
SELECT setval(pg_get_serial_sequence('capsule_installation', 'install_id'), 10);

-- 触发器：当胶囊被安装时更新状态
CREATE OR REPLACE FUNCTION update_capsule_status_on_install()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE capsule SET status = '已安装' WHERE capsule_id = NEW.capsule_id;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 创建触发器
CREATE TRIGGER trig_update_capsule_status
AFTER INSERT ON capsule_installation
FOR EACH ROW
EXECUTE FUNCTION update_capsule_status_on_install();

-- 提交事务
COMMIT; 