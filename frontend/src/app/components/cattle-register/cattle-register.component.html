<div class="cattle-register-container">
  <h2>ç‰›ç¾¤ä¿¡æ¯ç™»è®°</h2>
  
  <!-- æŸ¥è¯¢æ¡ä»¶è¡¨å• -->
  <div class="search-container">
    <div class="search-form">
      <div class="form-row">
        <div class="form-group">
          <label for="breedSearch">å“ç§</label>
          <input 
            type="text" 
            id="breedSearch" 
            [(ngModel)]="queryParams.breed" 
            placeholder="è¾“å…¥å“ç§">
        </div>
        
        <div class="form-group">
          <label for="genderSearch">æ€§åˆ«</label>
          <select id="genderSearch" [(ngModel)]="queryParams.gender">
            <option value="">å…¨éƒ¨</option>
            <option value="å…¬ç‰›">å…¬ç‰›</option>
            <option value="æ¯ç‰›">æ¯ç‰›</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="weightMinSearch">ä½“é‡èŒƒå›´(kg)</label>
          <div class="range-input">
            <input 
              type="number" 
              id="weightMinSearch" 
              [(ngModel)]="queryParams.weight_min" 
              placeholder="æœ€å°å€¼">
            <span>-</span>
            <input 
              type="number" 
              id="weightMaxSearch" 
              [(ngModel)]="queryParams.weight_max" 
              placeholder="æœ€å¤§å€¼">
          </div>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="birthDateStart">å‡ºç”Ÿæ—¥æœŸèŒƒå›´</label>
          <div class="range-input">
            <input 
              type="date" 
              id="birthDateStart" 
              [(ngModel)]="queryParams.birth_date_start">
            <span>-</span>
            <input 
              type="date" 
              id="birthDateEnd" 
              [(ngModel)]="queryParams.birth_date_end">
          </div>
        </div>
        
        <div class="form-group">
          <label for="createdAtStart">ç™»è®°æ—¶é—´èŒƒå›´</label>
          <div class="range-input">
            <input 
              type="date" 
              id="createdAtStart" 
              [(ngModel)]="queryParams.created_at_start">
            <span>-</span>
            <input 
              type="date" 
              id="createdAtEnd" 
              [(ngModel)]="queryParams.created_at_end">
          </div>
        </div>
      </div>
      
      <div class="form-controls">
        <button class="search-btn" (click)="searchCattle()">æŸ¥è¯¢</button>
        <button class="reset-btn" (click)="resetQuery()">é‡ç½®</button>
        <button class="add-btn" (click)="openAddForm(); $event.stopPropagation();" id="addCattleBtn">æ·»åŠ ç‰›åª</button>
      </div>
    </div>
  </div>
  
  <!-- åŠ è½½ä¸­çŠ¶æ€ -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="loading-spinner"></div>
    <p>æ­£åœ¨åŠ è½½ç‰›ç¾¤æ•°æ®ï¼Œè¯·ç¨å€™...</p>
  </div>
  
  <!-- é”™è¯¯æç¤º -->
  <div class="error-container" *ngIf="!isLoading && hasError">
    <div class="error-icon">!</div>
    <div class="error-message">
      <h3>åŠ è½½æ•°æ®å‡ºé”™</h3>
      <p>{{ errorMessage }}</p>
      <button class="retry-btn" (click)="loadCattleData()">é‡è¯•</button>
    </div>
  </div>
  
  <!-- æ•°æ®åˆ—è¡¨ -->
  <div class="cattle-list-container" *ngIf="!isLoading && !hasError">
    <table class="cattle-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>å“ç§</th>
          <th>æ€§åˆ«</th>
          <th>ä½“é‡(kg)</th>
          <th>å‡ºç”Ÿæ—¥æœŸ</th>
          <th>ç™»è®°æ—¶é—´</th>
          <th>ç‰›èƒƒèƒ¶å›Š</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let cattle of cattleList">
          <td>{{ cattle.cattle_id }}</td>
          <td>{{ cattle.breed }}</td>
          <td>{{ cattle.gender }}</td>
          <td>{{ cattle.weight }}</td>
          <td>{{ cattle.birth_date }}</td>
          <td>{{ cattle.created_at | date:'yyyy-MM-dd HH:mm:ss' }}</td>
          <td>{{ cattle.hasCapsule || 'å¦' }}</td>
          <td>
            <button class="edit-btn" (click)="openEditForm(cattle)">ç¼–è¾‘</button>
          </td>
        </tr>
        <tr *ngIf="cattleList.length === 0">
          <td colspan="8" class="no-data">
            <div class="empty-state">
              <div class="empty-icon">ğŸ“‹</div>
              <p>æš‚æ— ç‰›åªæ•°æ®</p>
              <small *ngIf="pagedResult.total === 0">æ•°æ®åº“ä¸­æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„ç‰›åªè®°å½•</small>
              <small *ngIf="pagedResult.total > 0">æ‰¾åˆ° {{ pagedResult.total }} æ¡è®°å½•ï¼Œä½†å½“å‰é¡µä¸ºç©º</small>
              <button *ngIf="pagedResult.total > 0" class="first-page-btn" (click)="changePage(1)">å›åˆ°ç¬¬ä¸€é¡µ</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    
    <!-- åˆ†é¡µæ§ä»¶ -->
    <div class="pagination" *ngIf="pagedResult.total > 0">
      <button 
        class="page-btn" 
        [disabled]="pagedResult.page === 1" 
        (click)="changePage(pagedResult.page - 1)">
        ä¸Šä¸€é¡µ
      </button>
      <span class="page-info">
        {{ pagedResult.page }} / {{ pagedResult.total_pages }} é¡µ
        (å…± {{ pagedResult.total }} æ¡è®°å½•)
      </span>
      <button 
        class="page-btn" 
        [disabled]="pagedResult.page === pagedResult.total_pages" 
        (click)="changePage(pagedResult.page + 1)">
        ä¸‹ä¸€é¡µ
      </button>
    </div>
  </div>
  
  <!-- æ·»åŠ /ç¼–è¾‘è¡¨å•æ¨¡æ€çª— -->
  <div class="modal-overlay" *ngIf="showForm">
    <div class="modal-content">
      <h3>{{ isEditMode ? 'ç¼–è¾‘ç‰›åªä¿¡æ¯' : 'æ·»åŠ ç‰›åªä¿¡æ¯' }}</h3>
      
      <div class="form-group">
        <label for="breed">å“ç§</label>
        <input 
          type="text" 
          id="breed" 
          [(ngModel)]="formData.breed" 
          required>
      </div>
      
      <div class="form-group">
        <label for="birthDate">å‡ºç”Ÿæ—¥æœŸ</label>
        <input 
          type="date" 
          id="birthDate" 
          [(ngModel)]="formData.birth_date" 
          required>
      </div>
      
      <div class="form-group">
        <label for="weight">ä½“é‡ (kg)</label>
        <input 
          type="number" 
          id="weight" 
          [(ngModel)]="formData.weight" 
          required 
          min="1">
      </div>
      
      <div class="form-group">
        <label for="gender">æ€§åˆ«</label>
        <select id="gender" [(ngModel)]="formData.gender" required>
          <option value="">è¯·é€‰æ‹©</option>
          <option value="å…¬ç‰›">å…¬ç‰›</option>
          <option value="æ¯ç‰›">æ¯ç‰›</option>
        </select>
      </div>
      
      <!-- èƒ¶å›Šé€‰æ‹© -->
      <div class="form-group">
        <label for="capsule">å…³è”ç‰›èƒƒèƒ¶å›Š</label>
        <select id="capsule" #capsuleSelect (change)="onCapsuleSelected(capsuleSelect.value)">
          <option value="">ä¸å…³è”èƒ¶å›Š</option>
          <option *ngFor="let capsule of inventoryCapsules" [value]="capsule.capsule_id" [selected]="selectedCapsule?.capsule_id === capsule.capsule_id">
            {{ capsule.capsule_id }} ({{ capsule.production_batch }})
          </option>
        </select>
        <div class="field-info" *ngIf="inventoryCapsules.length === 0">
          å½“å‰æ²¡æœ‰å¯ç”¨çš„åº“å­˜èƒ¶å›Š
        </div>
        <div class="field-info" *ngIf="selectedCapsule">
          å·²é€‰æ‹©èƒ¶å›Š: {{ selectedCapsule.capsule_id }}<br>
          ç”Ÿäº§æ‰¹æ¬¡: {{ selectedCapsule.production_batch }}<br>
          æ¿€æ´»æ—¥æœŸ: {{ selectedCapsule.activation_date }}<br>
          è¿‡æœŸæ—¥æœŸ: {{ selectedCapsule.expiration_date }}
        </div>
      </div>
      
      <div class="form-controls">
        <button class="save-btn" (click)="saveCattle()">ä¿å­˜</button>
        <button class="cancel-btn" (click)="closeForm()">å–æ¶ˆ</button>
      </div>
    </div>
  </div>
</div>
